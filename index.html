<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, updateDoc,
    deleteDoc, doc, serverTimestamp, orderBy, query,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // PROJECT: projeck-ic-non-hpl
  const firebaseConfig = {
    apiKey: "AIzaSyCQuOcC5KhMP9ilByeKzNTrlxXQ3IHI3Kk",
    authDomain: "projeck-ic-non-hpl.firebaseapp.com",
    projectId: "projeck-ic-non-hpl",
    storageBucket: "projeck-ic-non-hpl.firebasestorage.app",
    messagingSenderId: "799016578576",
    appId: "1:799016578576:web:f6d6383831331ffbde6495",
    measurementId: "G-VBV7364FNT"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const itemsCol = collection(db, "items");
  const logsCol  = collection(db, "logs");

  const THEME_KEY = "inventoryTheme_v1";
  const ADMIN_PIN = "1234";

  let items = [];
  let logs  = [];
  let isSaving = false;

  const itemForm        = document.getElementById("itemForm");
  const itemIdInput     = document.getElementById("itemId");
  const codeInput       = document.getElementById("code");
  const nameInput       = document.getElementById("nameInput");
  const categoryInput   = document.getElementById("category");
  const locationInput   = document.getElementById("location");
  const qtyInput        = document.getElementById("qty");
  const noteInput       = document.getElementById("note");
  const modeBadge       = document.getElementById("modeBadge");
  const saveBtn         = document.getElementById("saveBtn");
  const savingIndicator = document.getElementById("savingIndicator");
  const itemsBody       = document.getElementById("itemsBody");
  const logList         = document.getElementById("logList");
  const filterCodeInput = document.getElementById("filterCode");
  const themeLabel      = document.getElementById("themeLabel");

  // THEME
  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);
    themeLabel.textContent = theme === "dark" ? "Light mode" : "Dark mode";
  }
  window.toggleTheme = function () {
    const current = document.documentElement.getAttribute("data-theme") || "light";
    applyTheme(current === "light" ? "dark" : "light");
  };

  // REALTIME LISTENER ITEMS
  function listenItemsRealtime() {
    const q = query(itemsCol, orderBy("createdAt", "desc"));
    onSnapshot(
      q,
      (snap) => {
        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.renderItems();
      },
      (err) => {
        console.error("Gagal mengambil data items:", err);
        alert("Gagal mengambil data barang dari Firebase. Silakan cek console (F12 -> Console).");
      }
    );
  }

  // REALTIME LISTENER LOGS
  function listenLogsRealtime() {
    const q = query(logsCol, orderBy("time", "desc"));
    onSnapshot(
      q,
      (snap) => {
        logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderLogs();
      },
      (err) => {
        console.error("Gagal mengambil riwayat aktivitas:", err);
        alert("Gagal mengambil riwayat aktivitas dari Firebase. Silakan cek console (F12 -> Console).");
      }
    );
  }

  // LOGGING
  async function addLog(message) {
    try {
      await addDoc(logsCol, {
        message,
        time: serverTimestamp()
      });
    } catch (err) {
      console.error("Gagal simpan log:", err);
    }
  }

  // STATUS
  function getStatus(item) {
    return item.qty > 0 ? "ok" : "empty";
  }

  // RENDER ITEMS
  window.renderItems = function () {
    const filter = (filterCodeInput.value || "").trim().toLowerCase();
    itemsBody.innerHTML = "";
    items.forEach(item => {
      if (filter && !item.code.toLowerCase().includes(filter)) return;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.code}</td>
        <td>${item.name}${item.note ? `<div style="font-size:11px;color:var(--text-muted);">${item.note}</div>` : ""}</td>
        <td>${item.category || "-"}</td>
        <td>${item.location || "-"}</td>
        <td>${item.qty}</td>
        <td>
          <span class="status-dot status-${getStatus(item)}"></span>
          <span class="status-text">${item.qty>0?"Cukup":"Kosong"}</span>
        </td>
        <td>
          <button class="btn-secondary" onclick="editItem('${item.id}')">Edit</button>
          <button class="btn-danger" onclick="deleteItem('${item.id}')">Hapus</button>
        </td>
      `;
      itemsBody.appendChild(tr);
    });
  };

  // RENDER LOGS
  function renderLogs() {
    logList.innerHTML = "";
    if (!logs.length) {
      const li = document.createElement("li");
      li.className = "log-empty";
      li.textContent = "Belum ada aktivitas.";
      logList.appendChild(li);
      return;
    }
    logs.forEach(l => {
      const li = document.createElement("li");
      const time = l.time?.toDate ? l.time.toDate() : new Date();
      li.innerHTML = `
        <div>${l.message}</div>
        <div class="log-time">${time.toLocaleString("id-ID")}</div>
      `;
      logList.appendChild(li);
    });
  }

  // FORM HELPER
  window.resetForm = function () {
    itemForm.reset();
    itemIdInput.value = "";
    qtyInput.value = 0;
    modeBadge.textContent = "Tambah";
    saveBtn.textContent = "+ Tambah Barang";
  };

  window.editItem = function (id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    itemIdInput.value = item.id;
    codeInput.value = item.code;
    nameInput.value = item.name;
    categoryInput.value = item.category || "";
    locationInput.value = item.location || "";
    qtyInput.value = item.qty;
    noteInput.value = item.note || "";
    modeBadge.textContent = "Edit";
    saveBtn.textContent = "Simpan Perubahan";
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  function startSaving() {
    isSaving = true;
    saveBtn.disabled = true;
    saveBtn.textContent = "Menyimpan...";
    savingIndicator.style.display = "inline";
  }

  function stopSaving(originalText) {
    isSaving = false;
    saveBtn.disabled = false;
    if (originalText) saveBtn.textContent = originalText;
    savingIndicator.style.display = "none";
  }

  // SUBMIT FORM
  itemForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (isSaving) return;

    const data = {
      code: codeInput.value.trim(),
      name: nameInput.value.trim(),
      category: categoryInput.value.trim(),
      location: locationInput.value.trim(),
      qty: Number(qtyInput.value || 0),
      note: noteInput.value.trim()
    };

    if (!data.code || !data.name) {
      alert("Kode dan Jenis Barang wajib diisi.");
      return;
    }

    const id = itemIdInput.value || null;
    const originalText = saveBtn.textContent;

    startSaving();

    try {
      if (id) {
        const editor = prompt("Nama pengedit:");
        if (!editor || !editor.trim()) {
          alert("Nama pengedit wajib diisi.");
          stopSaving(originalText);
          return;
        }
        const old = items.find(i => i.id === id);
        const oldQty = old ? Number(old.qty || 0) : 0;
        const diff   = data.qty - oldQty;
        let perubahan = diff>0 ? `bertambah ${diff}` :
                        diff<0 ? `berkurang ${Math.abs(diff)}` :
                                 "tidak berubah";

        const ref = doc(db, "items", id);
        await updateDoc(ref, { ...data, updatedAt: serverTimestamp() });
        await addLog(`${editor.trim()} mengedit "${data.name}" (kode: ${data.code}), jumlah dari ${oldQty} menjadi ${data.qty} (${perubahan})`);
      } else {
        await addDoc(itemsCol, { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        await addLog(`Menambah "${data.name}" (kode: ${data.code}) dengan jumlah ${data.qty}`);
      }

      resetForm();
    } catch (err) {
      console.error(err);
      alert("Gagal menyimpan data.");
    } finally {
      stopSaving(originalText);
    }
  });

  // DELETE 1 ITEM
  window.deleteItem = async function (id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const deleter = prompt("Nama penghapus:");
    if (!deleter || !deleter.trim()) {
      alert("Nama penghapus wajib diisi.");
      return;
    }
    if (!confirm(`Hapus "${item.name}" (kode: ${item.code})?`)) return;

    try {
      const ref = doc(db, "items", id);
      await deleteDoc(ref);
      await addLog(`${deleter.trim()} menghapus "${item.name}" (kode: ${item.code}) sebanyak ${item.qty}`);
    } catch (err) {
      console.error(err);
      alert("Gagal menghapus data.");
    }
  };

  // HAPUS SEMUA ITEM
  window.clearAll = async function () {
    if (!items.length) return;
    const deleter = prompt("Nama penghapus semua data:");
    if (!deleter || !deleter.trim()) {
      alert("Nama penghapus wajib diisi.");
      return;
    }
    if (!confirm("Yakin hapus SEMUA data barang?")) return;

    try {
      const snap = await getDocs(itemsCol);
      let totalItem = 0, totalQty = 0;
      for (const d of snap.docs) {
        totalItem++;
        totalQty += Number(d.data().qty || 0);
        await deleteDoc(d.ref);
      }
      await addLog(`${deleter.trim()} menghapus SEMUA data (${totalItem} item, total ${totalQty} barang)`);
    } catch (err) {
      console.error(err);
      alert("Gagal hapus semua data.");
    }
  };

  // RESET LOGS
  window.resetLogs = async function () {
    const pin = prompt("Masukkan PIN admin untuk reset riwayat:");
    if (pin !== ADMIN_PIN) {
      alert("PIN salah.");
      return;
    }
    if (!confirm("Yakin reset semua riwayat aktivitas?")) return;
    try {
      const snap = await getDocs(logsCol);
      for (const d of snap.docs) {
        await deleteDoc(d.ref);
      }
    } catch (err) {
      console.error(err);
      alert("Gagal reset riwayat.");
    }
  };

  // Dummy, tidak dipakai lagi (biar nggak error kalau ada yang masih manggil)
  async function refreshAll() {}

  // INIT
  (function init() {
    const savedTheme = localStorage.getItem(THEME_KEY) || "light";
    applyTheme(savedTheme);
    listenItemsRealtime();
    listenLogsRealtime();
  })();
</script>
